<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rail Flow Visual Calculator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            color-scheme: light dark;
            --bg-gradient: linear-gradient(145deg, #060822 0%, #17203c 55%, #0d331f 100%);
            --panel-bg: rgba(10, 15, 35, 0.65);
            --panel-border: rgba(255, 255, 255, 0.08);
            --accent: #6df8ff;
            --accent-strong: #ff4f8b;
            --text-primary: #f7fbff;
            --text-secondary: rgba(247, 251, 255, 0.7);
            --success: #63f5b2;
            --warning-bg: rgba(255, 79, 139, 0.08);
            --warning-border: rgba(255, 79, 139, 0.4);
            font-family: "Space Grotesk", system-ui, sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            background: var(--bg-gradient);
            color: var(--text-primary);
            display: flex;
            justify-content: center;
            padding: 40px 24px 80px;
        }

        .app-shell {
            width: min(1160px, 100%);
            display: grid;
            gap: 28px;
        }

        header {
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 28px;
            backdrop-filter: blur(18px);
            padding: 28px 36px 32px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 24px 60px rgba(0, 0, 0, 0.35);
        }

        header::after {
            content: "";
            position: absolute;
            inset: -60px;
            background: radial-gradient(circle at top right, rgba(109, 248, 255, 0.25), transparent 55%);
            pointer-events: none;
            transform: rotate(-8deg);
        }

        header h1 {
            margin: 0;
            font-size: clamp(2.6rem, 4vw, 3.4rem);
            font-weight: 700;
            letter-spacing: -0.03em;
        }

        header p {
            margin: 14px 0 0;
            max-width: 680px;
            font-size: 1.05rem;
            color: var(--text-secondary);
            line-height: 1.65;
        }

        .controls-panel {
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 24px;
            padding: 24px 28px 30px;
            display: grid;
            gap: 24px;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
        }

        .control-card {
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            background: rgba(13, 19, 42, 0.75);
            padding: 20px 22px 22px;
            display: grid;
            gap: 16px;
            transition: transform 0.18s ease, box-shadow 0.18s ease;
        }

        .control-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 18px 45px rgba(0, 0, 0, 0.28);
        }

        .control-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
        }

        .control-title span {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 12px;
            background: rgba(109, 248, 255, 0.18);
            color: var(--accent);
            font-weight: 700;
        }

        label {
            display: grid;
            gap: 6px;
            font-size: 0.95rem;
            color: var(--text-secondary);
        }

        input,
        select {
            font: inherit;
            background: rgba(5, 9, 22, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            color: var(--text-primary);
            padding: 10px 14px;
            transition: border 0.16s ease, background 0.16s ease;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
            background: rgba(5, 9, 22, 0.95);
        }

        .train-controls {
            display: grid;
            gap: 14px;
            padding-top: 6px;
        }

        .train-row {
            display: grid;
            grid-template-columns: 70px repeat(5, minmax(0, 1fr));
            gap: 12px;
            align-items: center;
            background: rgba(8, 12, 29, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 14px 18px;
        }

        .train-row strong {
            font-weight: 600;
            font-size: 1rem;
            letter-spacing: 0.02em;
        }

        .train-row input {
            width: 100%;
        }

        .train-row input[type="time"] {
            padding-inline-end: 0;
        }

        .slider-wrap {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 18px 20px;
            border-radius: 16px;
            background: rgba(8, 12, 28, 0.72);
            border: 1px solid rgba(96, 231, 231, 0.16);
        }

        .file-upload input[type="file"] {
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px dashed rgba(109, 248, 255, 0.3);
            background: rgba(5, 9, 22, 0.78);
            color: var(--text-secondary);
            cursor: pointer;
            transition: border 0.16s ease, background 0.16s ease;
        }

        .file-upload input[type="file"]:hover {
            border-color: rgba(109, 248, 255, 0.55);
            background: rgba(5, 9, 22, 0.88);
        }

        .slider-wrap input[type="range"] {
            flex-grow: 1;
            accent-color: var(--accent);
        }

        button {
            font: inherit;
            padding: 12px 22px;
            border-radius: 14px;
            border: none;
            color: #04101c;
            background: linear-gradient(135deg, #6df8ff, #63f5b2);
            font-weight: 600;
            letter-spacing: 0.02em;
            cursor: pointer;
            box-shadow: 0 12px 25px rgba(54, 210, 210, 0.28);
            transition: transform 0.16s ease, box-shadow 0.16s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 18px 35px rgba(54, 210, 210, 0.32);
        }

        button.secondary {
            background: rgba(5, 9, 22, 0.85);
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: none;
        }

        .visual-panel {
            background: var(--panel-bg);
            border: 1px solid var(--panel-border);
            border-radius: 28px;
            padding: 26px 30px 32px;
            display: grid;
            gap: 24px;
        }

        .visual-header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 14px;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: center;
            color: var(--text-secondary);
        }

        .legend span {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }

        .dot {
            display: inline-flex;
            width: 18px;
            height: 18px;
            border-radius: 50%;
        }

        .dot.safe {
            background: var(--accent);
        }

        .dot.warning {
            background: var(--accent-strong);
        }

        .svg-wrapper {
            background: rgba(6, 11, 25, 0.78);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 24px;
            position: relative;
            overflow: hidden;
        }

        svg {
            width: 100%;
            height: auto;
            display: block;
        }

        .track-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 8px;
            letter-spacing: 0.04em;
        }

        .warnings {
            border-radius: 18px;
            background: rgba(8, 12, 29, 0.68);
            border: 1px solid rgba(96, 231, 231, 0.12);
            padding: 6px 20px 18px;
            display: grid;
            gap: 12px;
        }

        .warning-item {
            padding: 12px 16px 13px;
            border-radius: 14px;
            background: var(--warning-bg);
            border: 1px solid var(--warning-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .warning-item strong {
            color: var(--accent-strong);
            letter-spacing: 0.03em;
        }

        .warning-item span {
            color: var(--text-secondary);
            font-size: 0.93rem;
        }

        .warning-item em {
            font-style: normal;
            color: rgba(255, 255, 255, 0.78);
            font-weight: 600;
        }

        .no-warnings {
            color: var(--success);
            font-weight: 600;
            letter-spacing: 0.05em;
            padding: 14px 16px 10px;
        }

        @media (max-width: 960px) {
            .train-row {
                grid-template-columns: repeat(2, minmax(0, 1fr));
                padding: 16px;
                gap: 10px;
            }

            .train-row strong {
                grid-column: 1 / -1;
                margin-bottom: 4px;
            }

            .legend {
                justify-content: center;
            }
        }

        @media (max-width: 600px) {
            body {
                padding: 28px 18px 60px;
            }

            header {
                padding: 22px 24px 28px;
            }

            .controls-panel,
            .visual-panel {
                padding-inline: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="app-shell">
        <header>
            <h1>Rail Flow Visual Calculator</h1>
            <p>
                Design a safe timetable for up to ten trains on a shared line. Tweak departure times, speeds, consist
                lengths, and more while the live SVG dashboard shows spacing, crossing allowances, and real-time conflict alerts.
            </p>
        </header>

        <section class="controls-panel">
            <div class="controls-grid">
                <div class="control-card">
                    <div class="control-title">
                        <span>①</span>
                        <h2 style="margin: 0;">Train Matrix</h2>
                    </div>
                    <label>
                        Number of Trains
                        <input id="train-count" type="range" min="1" max="1000" value="4">
                    </label>
                    <div style="display: flex; justify-content: space-between; align-items: baseline;">
                        <small style="color: var(--text-secondary); letter-spacing: 0.05em;">Minimum 1 • Maximum 1000</small>
                        <strong id="train-count-label" style="font-size: 1.2rem;">4 trains</strong>
                    </div>
                </div>

                <div class="control-card">
                    <div class="control-title">
                        <span>②</span>
                        <h2 style="margin: 0;">Timeline</h2>
                    </div>
                    <div class="slider-wrap">
                        <label style="flex-grow: 1;">
                            Simulation Time
                            <input id="time-slider" type="range" min="0" max="180" value="0">
                        </label>
                        <div style="display: grid; gap: 4px;">
                            <strong id="time-label" style="font-size: 1.2rem;">08:00</strong>
                            <small style="color: var(--text-secondary);" id="time-offset-label">+0 min</small>
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button id="play-toggle" type="button">Play</button>
                        <button id="reset-time" class="secondary" type="button">Reset Time</button>
                    </div>
                </div>

                <div class="control-card">
                    <div class="control-title">
                        <span>③</span>
                        <h2 style="margin: 0;">Map Overlay</h2>
                    </div>
                    <label class="file-upload">
                        SVG Track Map
                        <input id="map-upload" type="file" accept=".svg,image/svg+xml">
                    </label>
                    <small id="map-status" style="color: var(--text-secondary); letter-spacing: 0.05em;">No map uploaded.</small>
                    <button id="clear-map" class="secondary" type="button" style="justify-self: start;">Remove Map</button>
                </div>
            </div>

            <div class="train-controls" id="train-controls"></div>
        </section>

        <section class="visual-panel">
            <div class="visual-header">
                <div>
                    <h2 style="margin: 0 0 4px; font-size: 1.6rem;">Live Track View</h2>
                    <small style="color: var(--text-secondary); letter-spacing: 0.06em;">Los Santos – Angel Pine Mainline (240 km)</small>
                </div>
                <div class="legend">
                    <span><span class="dot safe"></span>Safe Separation</span>
                    <span><span class="dot warning"></span>Unsafe Gap (&lt; 100 m)</span>
                </div>
            </div>

            <div class="svg-wrapper">
                <svg id="track-svg" viewBox="0 0 1200 280" preserveAspectRatio="xMidYMid meet">
                    <defs>
                        <linearGradient id="trainGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#6df8ff"/>
                            <stop offset="100%" stop-color="#63f5b2"/>
                        </linearGradient>
                        <linearGradient id="warningGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#ff4f8b"/>
                            <stop offset="100%" stop-color="#ff926c"/>
                        </linearGradient>
                        <filter id="glow">
                            <feGaussianBlur stdDeviation="6" result="coloredBlur"/>
                            <feMerge>
                                <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                    </defs>
                    <g id="map-layer"></g>
                    <g id="track-base"></g>
                    <g id="train-layer"></g>
                </svg>
            </div>
            <div class="track-labels">
                <span>0 km</span>
                <span>60 km</span>
                <span>120 km</span>
                <span>180 km</span>
                <span>220 km</span>
                <span>240 km</span>
            </div>

            <div class="warnings" id="warnings-panel">
                <div class="no-warnings">All clear — no spacing conflicts detected.</div>
            </div>
        </section>
    </div>

    <script>
        const SAFE_DISTANCE_KM = 0.1; // 100 m
        const CROSSINGS = [60, 120, 180, 220];
        const TRACK_LENGTH_KM = 240;
        const MAX_TRAINS = 1000;
        const DEFAULT_TRAINS = [
            { name: "A", departure: "08:00", speed: 80, distance: 240, cars: 8, carLength: 20 },
            { name: "B", departure: "08:30", speed: 60, distance: 240, cars: 10, carLength: 25 },
            { name: "C", departure: "09:00", speed: 100, distance: 240, cars: 6, carLength: 18 },
            { name: "D", departure: "09:15", speed: 90, distance: 240, cars: 12, carLength: 22 },
            { name: "E", departure: "09:45", speed: 85, distance: 240, cars: 9, carLength: 21 },
            { name: "F", departure: "10:10", speed: 95, distance: 240, cars: 7, carLength: 19 },
            { name: "G", departure: "10:25", speed: 70, distance: 240, cars: 10, carLength: 20 },
            { name: "H", departure: "10:40", speed: 105, distance: 240, cars: 5, carLength: 23 },
            { name: "I", departure: "11:05", speed: 88, distance: 240, cars: 11, carLength: 21 },
            { name: "J", departure: "11:25", speed: 75, distance: 240, cars: 8, carLength: 22 }
        ];

        const trainCountInput = document.getElementById("train-count");
        const trainCountLabel = document.getElementById("train-count-label");
        const trainControlsContainer = document.getElementById("train-controls");
        const timeSlider = document.getElementById("time-slider");
        const timeLabel = document.getElementById("time-label");
        const timeOffsetLabel = document.getElementById("time-offset-label");
        const playToggle = document.getElementById("play-toggle");
        const resetTimeBtn = document.getElementById("reset-time");
        const trainLayer = document.getElementById("train-layer");
        const mapLayer = document.getElementById("map-layer");
        const warningsPanel = document.getElementById("warnings-panel");
        const mapUploadInput = document.getElementById("map-upload");
        const clearMapBtn = document.getElementById("clear-map");
        const mapStatus = document.getElementById("map-status");

        trainCountInput.max = MAX_TRAINS;
        let trains = [];
        let baseDepartureMinutes = null;
        let maxTimelineMinutes = 180;
        let animationFrame = null;
        let lastFrameTime = null;
        let playing = false;

        const createSvgElement = (tag, attributes = {}) => {
            const el = document.createElementNS("http://www.w3.org/2000/svg", tag);
            Object.entries(attributes).forEach(([key, value]) => {
                el.setAttribute(key, value);
            });
            return el;
        };

        const formatTime = minutes => {
            const totalMinutes = (baseDepartureMinutes ?? 0) + minutes;
            const hours = Math.floor(totalMinutes / 60) % 24;
            const mins = totalMinutes % 60;
            return `${String(hours).padStart(2, "0")}:${String(mins).padStart(2, "0")}`;
        };

        const parseTimeToMinutes = hhmm => {
            const [h, m] = hhmm.split(":").map(Number);
            return h * 60 + m;
        };

        const cloneDefaultTrain = index => {
            const template = DEFAULT_TRAINS[index] ?? DEFAULT_TRAINS[DEFAULT_TRAINS.length - 1];
            return { ...template, name: String.fromCharCode(65 + index) };
        };

        const buildTrainControls = count => {
            trainControlsContainer.innerHTML = "";
            trains = [];

            for (let i = 0; i < count; i += 1) {
                const train = cloneDefaultTrain(i);
                trains.push(train);

                const row = document.createElement("div");
                row.className = "train-row";
                row.dataset.index = i;

                row.innerHTML = `
                    <strong>Train ${train.name}</strong>
                    <label>Departure<input type="time" value="${train.departure}" data-field="departure"></label>
                    <label>Speed (km/h)<input type="number" min="10" max="200" value="${train.speed}" data-field="speed"></label>
                    <label>Distance (km)<input type="number" min="10" max="240" value="${train.distance}" data-field="distance"></label>
                    <label>Cars<input type="number" min="1" max="20" value="${train.cars}" data-field="cars"></label>
                    <label>Car Length (m)<input type="number" min="5" max="40" value="${train.carLength}" data-field="carLength"></label>
                `;

                row.querySelectorAll("input").forEach(input => {
                    input.addEventListener("input", handleTrainInput);
                });

                trainControlsContainer.appendChild(row);
            }

            recalcTimeline();
            render();
        };

        const handleTrainInput = event => {
            const row = event.target.closest(".train-row");
            const index = Number(row.dataset.index);
            const field = event.target.dataset.field;
            const value = event.target.type === "time" ? event.target.value : Number(event.target.value);

            trains[index][field] = value;
            if (field === "departure") {
                trains[index].departure = value;
            }

            recalcTimeline();
            render();
        };

        const deriveTrainState = train => {
            const departureMinutes = parseTimeToMinutes(train.departure);
            const travelMinutes = (train.distance / train.speed) * 60;
            return {
                ...train,
                departureMinutes,
                arrivalMinutes: departureMinutes + travelMinutes,
                lengthKm: (train.cars * train.carLength) / 1000
            };
        };

        const recalcTimeline = () => {
            const states = trains.map(deriveTrainState);
            const departures = states.map(t => t.departureMinutes);
            const arrivals = states.map(t => t.arrivalMinutes);
            baseDepartureMinutes = Math.min(...departures);
            maxTimelineMinutes = Math.ceil(Math.max(...arrivals) - baseDepartureMinutes);
            timeSlider.max = Math.max(maxTimelineMinutes, 60);
            if (Number(timeSlider.value) > Number(timeSlider.max)) {
                timeSlider.value = timeSlider.max;
            }
            updateTimeLabels();
        };

        const updateTimeLabels = () => {
            const minutes = Number(timeSlider.value);
            timeLabel.textContent = formatTime(minutes);
            const offset = minutes;
            timeOffsetLabel.textContent = offset === 0 ? "+0 min" : `+${offset} min`;
        };

        const calculatePositions = minutes => {
            const states = trains.map(deriveTrainState);
            const currentMinute = (baseDepartureMinutes ?? 0) + minutes;

            return states
                .map((train, idx) => {
                    if (currentMinute < train.departureMinutes || currentMinute > train.arrivalMinutes) {
                        return null;
                    }

                    const elapsedHours = (currentMinute - train.departureMinutes) / 60;
                    const distance = train.speed * elapsedHours;

                    return {
                        index: idx,
                        name: train.name,
                        distance,
                        state: train
                    };
                })
                .filter(Boolean);
        };

        const checkWarnings = positions => {
            const warnings = [];

            for (let i = 0; i < positions.length; i += 1) {
                for (let j = i + 1; j < positions.length; j += 1) {
                    const trainA = positions[i];
                    const trainB = positions[j];
                    const gap = Math.abs(trainA.distance - trainB.distance) - (trainA.state.lengthKm + trainB.state.lengthKm);
                    const nearCrossing = CROSSINGS.some(crossing =>
                        Math.abs(trainA.distance - crossing) < 0.01 && Math.abs(trainB.distance - crossing) < 0.01
                    );

                    if (gap < SAFE_DISTANCE_KM && !nearCrossing) {
                        warnings.push({
                            trains: [trainA, trainB],
                            gapKm: gap,
                            gapMeters: Math.max(gap * 1000, 0)
                        });
                    }
                }
            }

            return warnings;
        };

        const renderWarnings = warnings => {
            warningsPanel.innerHTML = "";

            if (!warnings.length) {
                warningsPanel.innerHTML = `<div class="no-warnings">All clear — no spacing conflicts detected.</div>`;
                return;
            }

            warnings.forEach(warning => {
                const item = document.createElement("div");
                item.className = "warning-item";
                const [trainA, trainB] = warning.trains;
                item.innerHTML = `
                    <strong>Spacing Alert</strong>
                    <span>${trainA.name} ↔ ${trainB.name}</span>
                    <em>${warning.gapMeters.toFixed(1)} m</em>
                `;
                warningsPanel.appendChild(item);
            });
        };

        const render = () => {
            const minutes = Number(timeSlider.value);
            updateTimeLabels();

            trainLayer.innerHTML = "";
            const positions = calculatePositions(minutes);
            const warnings = checkWarnings(positions);
            const warningIndexes = new Set();

            warnings.forEach(w => {
                w.trains.forEach(train => warningIndexes.add(train.index));
            });

            const paddingX = 80;
            const minY = 70;
            const maxY = 220;
            const laneSpacing = (maxY - minY) / Math.max(trains.length, 1);

            positions.forEach((train, idx) => {
                const lane = idx;
                const x = paddingX + (train.distance / TRACK_LENGTH_KM) * (1200 - paddingX * 2);
                const y = minY + lane * laneSpacing;
                const lengthPx = Math.max(24, (train.state.lengthKm / TRACK_LENGTH_KM) * (1200 - paddingX * 2));
                const isWarning = warningIndexes.has(train.index);

                const group = document.createElementNS("http://www.w3.org/2000/svg", "g");
                group.setAttribute("transform", `translate(${x}, ${y})`);

                const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                rect.setAttribute("x", -lengthPx / 2);
                rect.setAttribute("y", -16);
                rect.setAttribute("width", lengthPx);
                rect.setAttribute("height", 32);
                rect.setAttribute("rx", 10);
                rect.setAttribute("fill", isWarning ? "url(#warningGradient)" : "url(#trainGradient)");
                rect.setAttribute("filter", isWarning ? "url(#glow)" : "");

                const labelBg = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                labelBg.setAttribute("x", -lengthPx / 2);
                labelBg.setAttribute("y", -42);
                labelBg.setAttribute("width", Math.max(70, lengthPx));
                labelBg.setAttribute("height", 24);
                labelBg.setAttribute("rx", 8);
                labelBg.setAttribute("fill", "rgba(3, 9, 22, 0.85)");

                const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
                label.setAttribute("fill", "#f0f7ff");
                label.setAttribute("font-size", "14");
                label.setAttribute("font-weight", "600");
                label.setAttribute("text-anchor", "middle");
                label.setAttribute("y", -24);
                label.textContent = `${train.name} • ${train.state.speed} km/h`;

                group.appendChild(labelBg);
                group.appendChild(label);
                group.appendChild(rect);

                const nose = document.createElementNS("http://www.w3.org/2000/svg", "polygon");
                nose.setAttribute("points", "0,-18 18,0 0,18");
                nose.setAttribute("fill", isWarning ? "#ff4f8b" : "#6df8ff");
                nose.setAttribute("opacity", "0.75");
                group.appendChild(nose);

                const positionTag = document.createElementNS("http://www.w3.org/2000/svg", "text");
                positionTag.setAttribute("fill", "rgba(255,255,255,0.7)");
                positionTag.setAttribute("font-size", "12");
                positionTag.setAttribute("text-anchor", "middle");
                positionTag.setAttribute("y", 28);
                positionTag.textContent = `${train.distance.toFixed(1)} km`;
                group.appendChild(positionTag);

                trainLayer.appendChild(group);
            });

            renderWarnings(warnings);
        };

        const buildTrack = () => {
            const trackBase = document.getElementById("track-base");
            trackBase.innerHTML = "";

            const ballast = createSvgElement("rect", {
                x: 70,
                y: 118,
                width: 1060,
                height: 64,
                rx: 26,
                fill: "rgba(30, 55, 77, 0.45)",
                stroke: "rgba(109, 248, 255, 0.12)",
                "stroke-width": "2"
            });
            trackBase.appendChild(ballast);

            const tieCount = 34;
            const tieSpacing = 1040 / (tieCount - 1);
            for (let i = 0; i < tieCount; i += 1) {
                const tieX = 80 + i * tieSpacing;
                const tie = createSvgElement("rect", {
                    x: tieX - 9,
                    y: 128,
                    width: 18,
                    height: 44,
                    rx: 6,
                    fill: "rgba(12, 20, 36, 0.85)",
                    stroke: "rgba(109, 248, 255, 0.08)",
                    "stroke-width": "1"
                });
                tie.setAttribute("opacity", i % 2 === 0 ? "0.6" : "0.45");
                trackBase.appendChild(tie);
            }

            const upperRail = createSvgElement("line", {
                x1: 80,
                x2: 1120,
                y1: 134,
                y2: 134,
                stroke: "rgba(109, 248, 255, 0.85)",
                "stroke-width": "6",
                "stroke-linecap": "round"
            });
            trackBase.appendChild(upperRail);

            const lowerRail = createSvgElement("line", {
                x1: 80,
                x2: 1120,
                y1: 166,
                y2: 166,
                stroke: "rgba(99, 242, 210, 0.85)",
                "stroke-width": "6",
                "stroke-linecap": "round"
            });
            trackBase.appendChild(lowerRail);

            const centerHighlight = createSvgElement("line", {
                x1: 80,
                x2: 1120,
                y1: 150,
                y2: 150,
                stroke: "rgba(255, 255, 255, 0.12)",
                "stroke-width": "3",
                "stroke-linecap": "round",
                "stroke-dasharray": "14 18"
            });
            trackBase.appendChild(centerHighlight);

            const startStation = createSvgElement("g", { transform: "translate(80, 150)" });
            const startMarker = createSvgElement("circle", {
                r: 18,
                fill: "rgba(6, 10, 28, 0.92)",
                stroke: "rgba(109, 248, 255, 0.85)",
                "stroke-width": "3"
            });
            const startInner = createSvgElement("circle", {
                r: 9,
                fill: "rgba(99, 242, 210, 0.95)"
            });
            const startLabel = createSvgElement("text", {
                x: -26,
                y: -34,
                fill: "rgba(247, 251, 255, 0.9)",
                "font-size": "13",
                "font-weight": "600",
                "text-anchor": "end",
                "letter-spacing": "0.08em"
            });
            startLabel.textContent = "Origin Terminal • 0 km";
            startStation.appendChild(startMarker);
            startStation.appendChild(startInner);
            startStation.appendChild(startLabel);
            trackBase.appendChild(startStation);

            const endStation = createSvgElement("g", { transform: "translate(1120, 150)" });
            const endMarker = createSvgElement("circle", {
                r: 18,
                fill: "rgba(6, 10, 28, 0.92)",
                stroke: "rgba(255, 79, 139, 0.9)",
                "stroke-width": "3"
            });
            const endInner = createSvgElement("circle", {
                r: 9,
                fill: "rgba(255, 146, 108, 0.95)"
            });
            const endLabel = createSvgElement("text", {
                x: 26,
                y: -34,
                fill: "rgba(247, 251, 255, 0.9)",
                "font-size": "13",
                "font-weight": "600",
                "text-anchor": "start",
                "letter-spacing": "0.08em"
            });
            endLabel.textContent = "Summit Station • 240 km";
            endStation.appendChild(endMarker);
            endStation.appendChild(endInner);
            endStation.appendChild(endLabel);
            trackBase.appendChild(endStation);

            CROSSINGS.forEach(crossing => {
                const x = 80 + (crossing / TRACK_LENGTH_KM) * (1120 - 80);
                const line = createSvgElement("line", {
                    x1: x,
                    x2: x,
                    y1: 100,
                    y2: 200,
                    stroke: "rgba(255, 255, 255, 0.22)",
                    "stroke-width": "2",
                    "stroke-dasharray": "6 6"
                });
                trackBase.appendChild(line);

                const label = createSvgElement("text", {
                    x: x,
                    y: 92,
                    fill: "rgba(247, 251, 255, 0.7)",
                    "font-size": "12",
                    "text-anchor": "middle",
                    "letter-spacing": "0.08em"
                });
                label.textContent = `${crossing} km crossing`;
                trackBase.appendChild(label);
            });
        };

        const handleMapUpload = event => {
            const file = event.target.files?.[0];

            if (!file) {
                return;
            }

            if (!file.type.includes("svg") && !file.name.toLowerCase().endsWith(".svg")) {
                mapStatus.textContent = "Unsupported file type. Please select an SVG file.";
                mapStatus.style.color = "var(--accent-strong)";
                return;
            }

            const reader = new FileReader();

            reader.onload = () => {
                try {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(reader.result, "image/svg+xml");
                    const parseError = doc.querySelector("parsererror");

                    if (parseError) {
                        throw new Error("Invalid SVG content.");
                    }

                    const uploadedSvg = doc.documentElement;
                    const nestedSvg = document.importNode(uploadedSvg, true);

                    if (!nestedSvg.getAttribute("width")) {
                        nestedSvg.setAttribute("width", "1200");
                    }
                    if (!nestedSvg.getAttribute("height")) {
                        nestedSvg.setAttribute("height", "280");
                    }

                    nestedSvg.setAttribute("x", nestedSvg.getAttribute("x") ?? "0");
                    nestedSvg.setAttribute("y", nestedSvg.getAttribute("y") ?? "0");
                    nestedSvg.setAttribute("preserveAspectRatio", nestedSvg.getAttribute("preserveAspectRatio") || "xMidYMid meet");

                    mapLayer.innerHTML = "";
                    mapLayer.appendChild(nestedSvg);

                    mapStatus.textContent = `Loaded: ${file.name}`;
                    mapStatus.style.color = "var(--text-secondary)";
                } catch (error) {
                    mapLayer.innerHTML = "";
                    mapStatus.textContent = `Error loading SVG: ${error.message}`;
                    mapStatus.style.color = "var(--accent-strong)";
                }
            };

            reader.onerror = () => {
                mapStatus.textContent = "Failed to read file.";
                mapStatus.style.color = "var(--accent-strong)";
            };

            reader.readAsText(file);
        };

        const clearMap = () => {
            mapLayer.innerHTML = "";
            mapUploadInput.value = "";
            mapStatus.textContent = "No map uploaded.";
            mapStatus.style.color = "var(--text-secondary)";
        };

        const stepAnimation = timestamp => {
            if (!playing) {
                return;
            }

            if (lastFrameTime === null) {
                lastFrameTime = timestamp;
            }

            const delta = timestamp - lastFrameTime;
            lastFrameTime = timestamp;

            const advanceMinutes = delta / 1000 * 5; // 5 minutes per second
            let newValue = Number(timeSlider.value) + advanceMinutes;

            if (newValue > Number(timeSlider.max)) {
                newValue = 0;
            }

            timeSlider.value = newValue;
            render();

            animationFrame = requestAnimationFrame(stepAnimation);
        };

        const togglePlay = () => {
            playing = !playing;
            playToggle.textContent = playing ? "Pause" : "Play";

            if (playing) {
                lastFrameTime = null;
                animationFrame = requestAnimationFrame(stepAnimation);
            } else if (animationFrame) {
                cancelAnimationFrame(animationFrame);
                animationFrame = null;
            }
        };

        const resetTime = () => {
            timeSlider.value = 0;
            updateTimeLabels();
            render();
        };

        trainCountInput.addEventListener("input", event => {
            const count = Number(event.target.value);
            trainCountLabel.textContent = `${count} ${count === 1 ? "train" : "trains"}`;
            buildTrainControls(count);
        });

        timeSlider.addEventListener("input", () => {
            if (playing) {
                togglePlay();
            }
            render();
        });

        playToggle.addEventListener("click", togglePlay);
        resetTimeBtn.addEventListener("click", resetTime);
        mapUploadInput.addEventListener("change", handleMapUpload);
        clearMapBtn.addEventListener("click", clearMap);

        buildTrack();
        buildTrainControls(Number(trainCountInput.value));
        render();
    </script>
</body>
</html>

